-content_for :page_title do
  -if @apartment.address_name.present?
    ==Cozily | #{@apartment.address.street}
  -else
    ==Cozily | Apartment ##{@apartment.id}

-if @apartment.published? || (signed_in? && @apartment.owned_by?(current_user))
  :javascript
    var self = #{@apartment.as_json(:methods => :to_param, :include => :address).to_json};
    var apartments = #{@apartment.comparable_apartments.as_json(:methods => :to_param, :include => :address).to_json};

  -if signed_in? && @apartment.owned_by?(current_user)
    =render "apartments/owner", :apartment => @apartment, :type => :show

  .article
    .head
      .name
        -if @apartment.address_name
          %h1=@apartment.address.street
          %h2==#{@apartment.address.city}, #{@apartment.address.state} #{@apartment.address.zip}
        -else
          %h1 Unknown Address

    .content
      - if @apartment.sublet?
        %h3.sublet sublet
      - if @apartment.images.present?
        = image_tag @apartment.images.first.asset.url(:large), :class => "active"
      - else
        = image_tag "defaults/apartment/large.jpg", :class => "active"

      .info
        .demographic
          .rooms
            ==#{@apartment.bedrooms.try(:prettify)}bd/#{@apartment.bathrooms.try(:prettify)}ba
          .rent
            ==$#{number_with_delimiter(@apartment.rent)}

          %ul
            - unless @apartment.square_footage.blank?
              %li
                ==#{@apartment.square_footage} sq. ft.
            %li
              -if @apartment.address && @apartment.neighborhoods
                ==Neighborhood: #{neighborhood_links(@apartment.neighborhoods)}
              -else
                Neighborhood: Unknown
            %li=availability(@apartment)

        -if @apartment.features.present?
          .highlights
            %h4 Highlights
            %dl
              - ["apartment", "building", "pet"].each do |category|
                - category_features = @apartment.features.all(:conditions => {:category => category})
                - if category_features.present?
                  %dt= "#{category.titleize} Features:"
                  - category_features.each do |feature|
                    %dd= feature.name

      .images
        %ul
          -@apartment.images.each do |image|
            %li=image_tag(image.asset.url(:thumb), :'data-large-image-path' => image.asset.url(:large))
          -if @apartment.images.empty?
            %li=image_tag("defaults/apartment/thumb.jpg")

      .contact
        %h3 Contact
        - if signed_in?
          %span.name=@apartment.user.full_name
          %span.email=@apartment.user.email
          %span.phone=number_to_phone(@apartment.user.phone, :area_code => true)

          -if can? :manage, Message
            =render "messages/thread", :apartment => @apartment
        - else
          %span.notice
            To contact this owner,
            = link_to "sign in", sign_in_path
            or
            = link_to "create an account", sign_up_path
            now!

  .aside
    %ul.actions
      %li.flag=render "flags/link", :apartment => @apartment
      %li.favorite=render "favorites/link", :apartment => @apartment
      %li.facebook
        %iframe{ :src =>"http://www.facebook.com/widgets/like.php?href=#{apartment_url(@apartment)}&layout=button_count&action=like&show_faces=false&width=99&height=21",
                 :scrolling => "no",
                 :frameborder => "0",
                 :allowTransparency => "true" }
      %li.twitter
        <a href="http://twitter.com/share" class="twitter-share-button" data-count="horizontal" data-via="cozidotly">Tweet</a><script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>

    #map_canvas
    =image_tag "backgrounds/shadow.png", :class => "shadow"

    #nearby_stations
      %h3 Nearby Stations
      %table
        -if @nearby_stations.present?
          -@nearby_stations.each do |station|
            %tr
              %td
                .name= station.name
                - station.trains.each do |train|
                  = image_tag "mta/#{train.name}.gif"
              %td==#{number_with_precision(station.distance, :precision => 2)}mi
        -else
          %tr
            %td None
    =image_tag "backgrounds/shadow.png", :class => "shadow"

    -if @apartment.address
      .business_search{:'data-lat' => @apartment.lat, :'data-lng' => @apartment.lng}

-else
  %p.unpublished
    -if @apartment.address.present?
      ==Oops, this apartment is unpublished.  Why not check out other places in #{neighborhood_links(@apartment.neighborhoods)}?
    -else
      ==Oops, this apartment is unpublished.  Why not check out this #{link_to("random apartment", Apartment.with_state(:published).first(:order => "RANDOM()"))}?
